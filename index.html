<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.css" rel="stylesheet" />
    <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-analysis@3"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.js"></script>
    <style>
      div.col { height: 300px; max-width: 50%; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col" id="users"></div>
        <div class="col" id="onboarding"></div>
      </div>
      <div class="row">
        <div class="col" id="listings"></div>
        <div class="col" id="bookings"></div>
      </div>
    </div>

    <form action="">
      <label for="start">Start</label>
      <input type="text" id="start" name="start">

      <label for="end">End</label>
      <input type="text" id="end" name="end">

      <label for="interval">Interval</label>
      <select id="interval" name="interval">
        <option value="minutely">Minute</option>
        <option value="hourly">Hour</option>
        <option value="daily">Day</option>
        <option value="weekly">Week</option>
        <option value="monthly">Month</option>
        <option value="yearly">Year</option>
      </select>

      <input type="submit" value="Query">
    </form>

    <!-- Create and Render -->
    <script>
      const client = new KeenAnalysis({
        projectId: '5c6471eec9e77c000121bb53',
        readKey: 'EA80E1D1209DDCCF3D7B01FA7D8461950D57B4207DCA0470DFE1770A81A5CCA42CF7CD4EBEFF904F76F55DCA0CCA23D0D9B68B87EED8601744FEBC9BB883AB46C674D8FD81603CAB827004BC78734189096152E6D9BA5D6A27418684562F9A0D'
      });
      const params = (new URL(document.location)).searchParams;
      
      const timeframe = {
        start: params.get('start') || '2018-08-20T12:00:00.000Z',
        end: params.get('end') || '2019-03-01T12:00:00.000Z'
      };
      const interval = params.get('interval') || 'weekly';

      document.getElementById('start').value = timeframe.start;
      document.getElementById('end').value = timeframe.end;
      document.getElementById('interval').value = interval;

      const listings = new KeenDataviz({
        container: '#listings',
        title: 'Listings',
        showLoadingSpinner: true,
        labelMapping: {
          'listingStarted count': 'Started',
          'listingPublished count': 'Published'
        },
        labels: [
          'Started',
          'Published',
          'Total started',
          'Total published'          
        ]
      });

      const bookings = new KeenDataviz({
        container: '#bookings',
        title: 'Bookings',
        showLoadingSpinner: true
      });

      const onboarding = new KeenDataviz({
        container: '#onboarding',
        title: 'Onboarding',
        showLoadingSpinner: true,
        labels: [
          'Verified',
          'Stripe',
          'Eth wallet',
          'Btc wallet',
          'Profile pic'
        ]
      });

      const users = new KeenDataviz({
        container: '#users',
        title: 'Users',
        showLoadingSpinner: true,
        labels: [
          'New users',
          'New hosts',
          'New guests'
        ]
      });

      const total = async results => {
        const priors = await client.query({
          ...results.query,
          timeframe: {
            start: '2018-01-01T12:00:00.000Z',
            end: results.query.timeframe.start
          },
          interval: 'yearly'
        });
        let sum = priors.result.reduce((total, point) => total += point.value, 0);
        const totals = results.result.map(point => {
          sum += point.value;
          return { ...point, value: sum };
        });
        return {
          ...results,
          query: { ...results.query, analysis_type: 'total' },
          result: totals
        };
      };

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'listingStarted',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'listingPublished',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'listingStarted',
          timeframe,
          interval: 'weekly'
        }).then(total),
        client.query({
          analysis_type: 'count',
          event_collection: 'listingPublished',
          timeframe,
          interval: 'weekly'
        }).then(total)
      ])
      .then(results => listings.render(results))
      .catch(error => listings.message(error.message));

      client.run([
        'bookingStarted',
        'bookingRequested',
        'bookingAccepted',
        'bookingRejected',
        'bookingRescinded',
        'bookingCancelled',
        'bookingPaidByGuest',
        'bookingPaidOut',
      ].map(event => client.query({
        analysis_type: 'count',
        event_collection: event,
        timeframe,
        interval: 'weekly'
      })))
      .then(results => bookings.render(results))
      .catch(error => bookings.message(error.message));

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'userVerified',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'userPayoutInfoCompleted',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'stripeExpressAccount',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'userPayoutInfoCompleted',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'ethWalletAddress',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'userPayoutInfoCompleted',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'btcWalletAddress',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'userPayoutInfoCompleted',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'profilePhoto',
            operator: 'eq',
            property_value: true
          }]
        })
      ])
      .then(results => onboarding.render(results))
      .catch(error => onboarding.message(error.message));

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'isHost',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'isHost',
            operator: 'eq',
            property_value: false
          }]
        })
      ])
      .then(results => users.render(results))
      .catch(error => users.message(error.message));
    </script>
  </body>
</html>