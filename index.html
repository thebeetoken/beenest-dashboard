<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.css" rel="stylesheet" />
    <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-analysis@3"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.js"></script>
    <style>
      div.col { height: 300px; max-width: 50%; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col" id="users"></div>
        <div class="col" id="hosts"></div>
      </div>
      <div class="row">
        <div class="col" id="listings"></div>
        <div class="col" id="bookings"></div>
      </div>
    </div>

    <!-- Create and Render -->
    <script>
      const client = new KeenAnalysis({
        projectId: '5c6471eec9e77c000121bb53',
        readKey: 'EA80E1D1209DDCCF3D7B01FA7D8461950D57B4207DCA0470DFE1770A81A5CCA42CF7CD4EBEFF904F76F55DCA0CCA23D0D9B68B87EED8601744FEBC9BB883AB46C674D8FD81603CAB827004BC78734189096152E6D9BA5D6A27418684562F9A0D'
      });
      
      const timeframe = {
        start: '2018-08-20T12:00:00.000Z',
        end: '2019-03-01T12:00:00.000Z'
      };

      const listings = new KeenDataviz({
        container: '#listings',
        title: 'Listings',
        showLoadingSpinner: true,
        labelMapping: {
          'listingStarted count': 'Started',
          'listingPublished count': 'Published'
        }
      });

      const bookings = new KeenDataviz({
        container: '#bookings',
        title: 'Bookings',
        showLoadingSpinner: true
      });

      const hosts = new KeenDataviz({
        container: '#hosts',
        title: 'Hosts',
        showLoadingSpinner: true,
        labelMapping: {
          'userPayoutInfoCompleted count': 'Payout info completed'
        }
      });

      const users = new KeenDataviz({
        container: '#users',
        title: 'Users',
        showLoadingSpinner: true,
        labels: [
          'New users',
          'New hosts',
          'New guests'
        ]
      });

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'listingStarted',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'listingPublished',
          timeframe,
          interval: 'weekly'
        })
      ])
      .then(results => listings.render(results))
      .catch(error => listings.message(error.message));

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'listingStarted',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'listingPublished',
          timeframe,
          interval: 'weekly'
        })
      ])
      .then(results => results.map(result => {
        let sum = 0;
        const totals = result.result.map(point => {
          sum += point.value;
          return { ...point, value: sum };
        });
        return {
          ...result,
          query: { ...result.query, analysis_type: 'total' },
          result: totals
        };
      }))
      .then(results => listings.render(results))
      .catch(error => listings.message(error.message));

      client.run([
        'bookingStarted',
        'bookingRequested',
        'bookingAccepted',
        'bookingRejected',
        'bookingRescinded',
        'bookingCancelled',
        'bookingPaidByGuest',
        'bookingPaidOut',
      ].map(event => client.query({
        analysis_type: 'count',
        event_collection: event,
        timeframe,
        interval: 'weekly'
      })))
      .then(results => bookings.render(results))
      .catch(error => bookings.message(error.message));

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'isHost',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'userPayoutInfoCompleted',
          timeframe,
          interval: 'weekly'
        })
      ])
      .then(results => hosts.render(results))
      .catch(error => hosts.message(error.message));

      client.run([
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly'
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'isHost',
            operator: 'eq',
            property_value: true
          }]
        }),
        client.query({
          analysis_type: 'count',
          event_collection: 'signup',
          timeframe,
          interval: 'weekly',
          filters: [{
            property_name: 'isHost',
            operator: 'eq',
            property_value: false
          }]
        })
      ])
      .then(results => users.render(results))
      .catch(error => users.message(error.message));
    </script>
  </body>
</html>