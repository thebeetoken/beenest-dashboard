<!DOCTYPE html>
<html>
<head>
    <title>Open MCT Tutorials</title>
    <script src="node_modules/openmct/dist/openmct.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-analysis@3"></script>
</head>
<body>
    <script>
        openmct.setAssetPath('node_modules/openmct/dist');
        openmct.install(openmct.plugins.LocalStorage());
        openmct.install(openmct.plugins.MyItems());
        openmct.install(openmct.plugins.UTCTimeSystem());
        openmct.time.timeSystem('utc', { start: Date.now() - 180 * 24 * 60 * 60 * 1000, end: Date.now() });
        openmct.install(openmct.plugins.Espresso());
        openmct.install(openmct.plugins.ImportExport());
        openmct.install(openmct.plugins.Conductor({
          menuOptions: [{
            name: 'Fixed',
            timeSystem: 'utc',
            bounds: { start: Date.now() - 180 * 24 * 60 * 60 * 1000, end: Date.now() },
            zoomOutLimit: 365 * 24 * 60 * 60 * 1000,
            zoomInLimit: 60 * 1000
          }]
        }));
        openmct.install(openmct.plugins.StaticRootPlugin('static', 'dashboards.json'));
        
        const client = new KeenAnalysis({
          projectId: '5c6471eec9e77c000121bb53',
          readKey: 'EA80E1D1209DDCCF3D7B01FA7D8461950D57B4207DCA0470DFE1770A81A5CCA42CF7CD4EBEFF904F76F55DCA0CCA23D0D9B68B87EED8601744FEBC9BB883AB46C674D8FD81603CAB827004BC78734189096152E6D9BA5D6A27418684562F9A0D'
        });
        openmct.objects.addRoot({ namespace: 'bee', key: 'metrics' });
        openmct.objects.addProvider('bee', {
          get: async identifier => {
            if (identifier.key === 'metrics') {
              return { identifier, name: "Metrics", type: 'folder', location: 'ROOT' };
            }
            return {
              identifier,
              name: identifier.key,
              type: 'metric',
              location: 'bee:metrics',
              telemetry: {
                values: [
                  {
                    "key": "value",
                    "name": "Value",
                    "format": "float",
                    "hints": { "range": 1 }
                  },
                  {
                    "key": "utc",
                    "source": "timestamp",
                    "name": "Time",
                    "format": "utc",
                    "hints": { "domain": 1 }
                  }
                ]
              }
            };
          }
        });
        openmct.composition.addProvider({
          appliesTo: obj => obj.identifier.namespace === 'bee' && obj.identifier.key == 'metrics',
          load: async obj => {
            const res = await client.get(client.url('events')).auth(client.readKey()).send();
            return res.map(metric => ({ namespace: 'bee', key: metric.name }))
          }
        });
        openmct.types.addType('metric', {
          name: 'Metric',
          description: 'A measurement.',
          cssClass: 'icon-telemetry'
        });
        openmct.types.addType('keen.query', {
          name: 'Keen Query',
          description: "A keen.io analytics query",
          cssClass: 'icon-telemetry',
          creatable: true,
          initialize: obj => {
            obj.query = '{}';
            obj.telemetry = {
              values: [
                {
                  "key": "value",
                  "name": "Value",
                  "format": "float",
                  "hints": { "range": 1 }
                },
                {
                  "key": "utc",
                  "source": "timestamp",
                  "name": "Time",
                  "format": "utc",
                  "hints": { "domain": 1 }
                }
              ]
            };
          },
          form: [
            {
              key: 'query',
              name: 'Query (JSON object)',
              control: 'textarea',
              required: true,
              cssClass: 'l-textarea-sm'
            },
            {
              key: 'total',
              name: 'Compute totals?',
              control: 'checkbox'
            }
          ]
        });
        openmct.telemetry.addProvider({
          supportsRequest: obj => obj.type === 'metric',
          request: async (obj, opts) => {
            const timeframe = { start: new Date(opts.start), end: new Date(opts.end) };
            const res = await client.query({
              analysis_type: 'count',
              event_collection: obj.identifier.key,
              timeframe,
              interval: 'weekly'
            });
            return res.result.map(({ value, timeframe }) => ({
              value,
              timestamp: new Date(timeframe.end).valueOf()
            }));
          }
        });
        openmct.telemetry.addProvider({
          supportsRequest: obj => obj.type === 'keen.query',
          request: async (obj, opts) => {
            const query = JSON.parse(obj.query);
            const timeframe = { start: new Date(opts.start), end: new Date(opts.end) };
            const res = await client.query({
              ...query,
              timeframe,
              interval: 'weekly'
            });
            console.log(res);
            return res.result.map(({ value, timeframe }) => ({
              value,
              timestamp: new Date(timeframe.end).valueOf()
            }));
          }
        });

        openmct.start();
    </script>
</body>
</html>
